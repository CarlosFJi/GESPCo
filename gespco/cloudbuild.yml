
# In this directory, run the following command to build this builder.
# $ gcloud builds submit . --config=cloudbuild.yaml

#steps:
#- name: 'gcr.io/cloud-builders/git'
#  args: ['clone', 'https://github.com/flutter/flutter']
#  dir: '/workspace'

# To run flutter build apk, one must need to  be at the root of the project, the script simply cd to the root before
# running the build command
#- name: 'gcr.io/gespco-cfj5b/repo-gespco'
#  entrypoint: '/bin/bash'
#  args: ['build. sh']

# apk artifacts can be pushed to a GCS bucket like this
# - name: 'gcr.io/cloud-builders/gsutil'
#   args: ['cp', '/workspace/flutter/examples/hello_world/build/app/outputs/apk/release/app-release.apk', 'gs://$MY_BUCKET/hello_world.apk']

#tags: ['cloud-builders-community']
secrets:
  - kmsKeyName: 'projects/gespco-cfj5b1/locations/global/keyRings/cloudbuilder/cryptoKeys/firebase-token'
    secretEnv:
      FIREBASE_TOKEN: 'CiQAwb9ZnZFM4FoWbO+MVf0EUe9RjPRcxiiCz4W6dt4Edo9LmvUSkAEA6gsnHUKbg86WNDIOP3F6qy0l1cfBI0oQjD0MhQaLMMFooGYFBs5aQbNrmZvrwOtHZHs3ZS5+1Fc1KBzQKfi7pCaWpJxVpGoz5JrWStKykptaL8jGCzHB6zYzxsEzQCc1wX6oekBWnCFl+AeFcosasQZQ53lnnu8g2JdIwzGwGlDcIjmgCjzo8Y+HFZVB9zk='

steps:
  # Step 0: Flutter install
  - name: 'gcr.io/cloud-builders/git'
    args: ['clone', 'https://github.com/flutter/flutter']
    dir: '/workspace'

  # Step 1: Build the Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args: ['run', '--rm', '-v', '/workspace:/app', 'cirrusci/flutter:stable', '/bin/bash', '-c', 'cd /app', 'start-apache.sh']
 
  # Step 2: Deploy to Firebase Hosting
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args: ['-c', 'firebase deploy --only=hosting',' --token=$FIREBASE_TOKEN']

options:
  logging: CLOUD_LOGGING_ONLY

images:
  - 'gcr.io/gespco-cfj5b1/repo-gespco'

timeout: '1200s'